<head>
  <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" data-auto-replace-svg="nest"></script>
  <style>
    .display {
      background-color: beige;
      height: 100%;
    }

    .load-button {
      position: absolute;
      font-size: large;
      background-color: #1f657a;
      color: white;
      border: 0;
      padding: 0.75rem 1.5rem;
      top: 1rem;
      left: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="display"></div>
  <button class="load-button" onclick="document.getElementById('file-input').click();"><i class="fas fa-upload"></i></button>
  <input id="file-input" type="file" name="name" onchange="loadJSON();" style="display: none;" />
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>    
    const buildNodes = (fileData) => {
      let subjects = fileData.map(node => node.subject)
      let objects = fileData.map(node => node.object)
      let nodes = [...subjects, ...objects].filter((node, i, arr) => arr.indexOf(node) === i).map(node => ({id: node}))

      return nodes
    }

    const buildLinks = (fileData) => {
      let subjectObjectLinks = fileData.map(node => ({source: node.subject, target: node.object}))
      
      return subjectObjectLinks
    }
  
    const buildGraph = (fileData) => {
      const data = {
        nodes: buildNodes(fileData),
        links: buildLinks(fileData)
      }
      console.log(data)

      const height = 720
      const width = 1280

      const svg = d3.select("#display")
        .append("svg")
        .attr("height", height)
        .attr("width", width)
        .classed("display", true)

      const nodes = svg
        .selectAll("circle")
        .data(data.nodes)
        .enter()
        .append("circle")
          .attr("r", 5)
          .style("fill", "navy")
        
      const labels = nodes
        .append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.id });

      const links = svg
        .selectAll("line")
        .data(data.links)
        .enter()
        .append("line")
          .style("stroke", "#aaa")

      const simulation = d3.forceSimulation(data.nodes)
        .force("charge", d3.forceManyBody())
        .force("link", d3.forceLink(data.links).id(node => node.id))
        .force("center", d3.forceCenter(width/2, height/2))
        .on("end", ticked);

  // This function is run at each iteration of the force algorithm, updating the nodes position.
      function ticked() {
        links
          .attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

        nodes
          .attr("cx", function (d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
      }
    }

    const loadJSON = function() {
      const file = document.getElementById('file-input').files[0]
      const reader = new FileReader()
      reader.onload = function(e) {
        let jsonString = e.target.result
        let fileData = JSON.parse(jsonString)
        buildGraph(fileData)
      }
      reader.readAsText(file, "utf-8")
    }
  </script>
</body>